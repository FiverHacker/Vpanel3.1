{% extends "base.html" %}

{% block title %}Creating VPS - {{ panel_name }}{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4">
    <div class="max-w-2xl w-full">
        <div class="card p-8">
            <div class="text-center mb-8">
                <div class="inline-block animate-spin rounded-full h-16 w-16 border-b-2 border-blue-500 mb-4"></div>
                <h1 class="text-3xl font-bold mb-2">Creating Your VPS</h1>
                <p class="text-gray-600">Please wait while we set up your virtual private server...</p>
            </div>

            <!-- Progress Bar -->
            <div class="mb-6">
                <div class="flex justify-between mb-2">
                    <span class="text-sm font-medium" id="statusText">Initializing...</span>
                    <span class="text-sm font-medium" id="progressText">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4 overflow-hidden">
                    <div id="progressBar" class="bg-blue-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <!-- Status Messages -->
            <div id="statusMessages" class="space-y-2 mb-6">
                <div class="text-sm text-gray-600">Starting creation process...</div>
            </div>

            <!-- Success/Error Messages -->
            <div id="successMessage" class="hidden p-4 bg-green-50 border border-green-200 rounded-lg mb-4">
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                    <span class="text-green-800" id="successText"></span>
                </div>
            </div>

            <div id="errorMessage" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg mb-4">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>
                    <span class="text-red-800" id="errorText"></span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div id="actionButtons" class="hidden space-x-4">
                <a href="{{ url_for('dashboard') }}" class="btn-primary px-6 py-2 rounded-lg">
                    <i class="fas fa-tachometer-alt mr-2"></i>Go to Dashboard
                </a>
                <a href="#" id="viewVpsLink" class="btn-secondary px-6 py-2 rounded-lg hidden">
                    <i class="fas fa-eye mr-2"></i>View VPS
                </a>
            </div>
        </div>
    </div>
</div>

<script>
const vpsId = '{{ vps_id }}';
let progressInterval;
let lastMessage = ''; // Track last displayed message to prevent duplicates
let lastProgress = -1; // Track last progress value

function updateProgress() {
    fetch(`/create_vps/progress/${vpsId}`)
        .catch(error => {
            console.error('Progress fetch error:', error);
            return { json: () => Promise.resolve({ status: 'error', progress: 0, message: 'Connection error' }) };
        })
        .then(response => response.json())
        .then(data => {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const statusText = document.getElementById('statusText');
            const statusMessages = document.getElementById('statusMessages');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            const actionButtons = document.getElementById('actionButtons');
            const viewVpsLink = document.getElementById('viewVpsLink');

            // Update progress
            progressBar.style.width = data.progress + '%';
            progressText.textContent = data.progress + '%';
            statusText.textContent = data.message || 'Processing...';

            // Handle error first (before adding status messages)
            if (data.status === 'error') {
                clearInterval(progressInterval);
                errorMessage.classList.remove('hidden');
                document.getElementById('errorText').textContent = data.message || 'An error occurred';
                actionButtons.classList.remove('hidden');
                return; // Stop processing once error is shown
            }

            // Add status message only if it's different from the last one
            if (data.message && data.message !== lastMessage && data.status !== 'error') {
                // Remove the "Starting creation process..." placeholder if it exists
                const placeholder = statusMessages.querySelector('div:first-child');
                if (placeholder && placeholder.textContent === 'Starting creation process...') {
                    placeholder.remove();
                }
                
                const messageDiv = document.createElement('div');
                messageDiv.className = 'text-sm text-gray-600';
                messageDiv.textContent = `âœ“ ${data.message}`;
                statusMessages.appendChild(messageDiv);
                statusMessages.scrollTop = statusMessages.scrollHeight;
                lastMessage = data.message; // Update last message
            }
            
            // Also update if progress changed significantly (to show progress updates)
            if (data.progress !== lastProgress && data.progress > lastProgress) {
                lastProgress = data.progress;
            }

            // Handle completion
            if (data.status === 'completed') {
                clearInterval(progressInterval);
                successMessage.classList.remove('hidden');
                document.getElementById('successText').textContent = 'VPS created successfully!';
                actionButtons.classList.remove('hidden');
                if (data.vps_id) {
                    viewVpsLink.href = `/vps/${data.vps_id}`;
                    viewVpsLink.classList.remove('hidden');
                }
                // Redirect after 3 seconds
                setTimeout(() => {
                    if (data.vps_id) {
                        window.location.href = `/vps/${data.vps_id}`;
                    } else {
                        window.location.href = '/dashboard';
                    }
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Progress update error:', error);
        });
}

// Start polling for progress (poll every 2 seconds to reduce load)
progressInterval = setInterval(updateProgress, 2000);
updateProgress(); // Initial update
</script>
{% endblock %}
