{% extends "base.html" %}

{% block title %}Console - {{ vps.vps_id }} - {{ panel_name }}{% endblock %}

{% block content %}
<div class="h-screen flex flex-col">
    <!-- Header -->
    <div class="bg-white border-b p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="{{ url_for('vps_details', vps_id=vps.vps_id) }}" 
                   class="text-blue-500 hover:text-blue-700">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div>
                    <h1 class="text-xl font-bold">Web Console - {{ vps.vps_id }}</h1>
                    <p class="text-gray-600 text-sm">SSH access via browser</p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <span class="status-{{ vps.status }} px-3 py-1 rounded-full text-sm">
                    {{ vps.status|title }}
                </span>
                <button onclick="toggleFullscreen()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Connection Form -->
    <div id="connectionForm" class="bg-gray-50 p-6 border-b">
        <div class="max-w-2xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Host</label>
                    <input type="text" id="sshHost" value="127.0.0.1" 
                           class="w-full rounded-md border-gray-300 shadow-sm" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Port</label>
                    <input type="number" id="sshPort" value="{{ vps.port }}" 
                           class="w-full rounded-md border-gray-300 shadow-sm" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="sshUsername" value="{{ vps.username }}" 
                           class="w-full rounded-md border-gray-300 shadow-sm" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <div class="flex space-x-2">
                        <input type="password" id="sshPassword" value="{{ vps.password }}" 
                               class="w-full rounded-md border-gray-300 shadow-sm" readonly>
                        <button onclick="togglePasswordVisibility()" type="button" 
                                class="bg-gray-200 px-3 rounded-md hover:bg-gray-300">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="mt-4 flex justify-center">
                <button onclick="connectSSH()" id="connectBtn"
                        class="btn-primary px-6 py-2 rounded-lg flex items-center space-x-2">
                    <i class="fas fa-terminal"></i>
                    <span>Connect to Console</span>
                </button>
            </div>
            <div class="mt-2 text-center text-sm text-gray-600">
                <p>Connect directly to your VPS container console</p>
            </div>
        </div>
    </div>

    <!-- Terminal Container -->
    <div id="terminalContainer" class="flex-1 bg-black hidden" style="position: relative;">
        <div id="terminal" class="h-full w-full p-4 font-mono text-green-400 overflow-auto" 
             style="outline: none; position: relative;"></div>
        <!-- Hidden input for keyboard capture -->
        <input type="text" id="terminalInput" 
               style="position: absolute; top: -9999px; left: -9999px; opacity: 0; width: 1px; height: 1px;"
               autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
    </div>

    <!-- Disconnected State -->
    <div id="disconnectedState" class="flex-1 flex items-center justify-center bg-gray-100">
        <div class="text-center">
            <i class="fas fa-terminal text-6xl text-gray-300 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-600">SSH Terminal</h3>
            <p class="text-gray-500 mt-2">Click the connect button to start your SSH session</p>
        </div>
    </div>

    <!-- Connection Status -->
    <div id="connectionStatus" class="bg-gray-800 text-white p-2 text-center hidden">
        <div class="flex items-center justify-center space-x-2">
            <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
            <span>Connected to {{ vps.vps_id }}</span>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
const socket = io('/console');
let isConnected = false;

function connectSSH() {
    const btn = document.getElementById('connectBtn');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';
    btn.disabled = true;

    const host = document.getElementById('sshHost').value;
    const port = document.getElementById('sshPort').value;
    const username = document.getElementById('sshUsername').value;
    const password = document.getElementById('sshPassword').value;

    // Connect directly to container console (no SSH needed)
    socket.emit('start_shell', {
        vps_id: '{{ vps.vps_id }}'
    });
}

function togglePasswordVisibility() {
    const passwordField = document.getElementById('sshPassword');
    const icon = event.target.querySelector('i') || event.target;
    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        passwordField.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

function toggleFullscreen() {
    const terminalContainer = document.getElementById('terminalContainer');
    if (!document.fullscreenElement) {
        terminalContainer.requestFullscreen().catch(err => {
            console.log(`Error attempting to enable fullscreen: ${err.message}`);
        });
    } else {
        document.exitFullscreen();
    }
}

// Socket event handlers
socket.on('connect', () => {
    console.log('Connected to WebSocket');
    isConnected = false; // Reset connection state
});

socket.on('connected', (data) => {
    console.log('Console server connected:', data);
});

socket.on('output', (data) => {
    const terminal = document.getElementById('terminal');
    if (terminal) {
        // Append output and maintain cursor at end
        terminal.innerHTML += data;
        terminal.scrollTop = terminal.scrollHeight;
        
        // Show terminal and hide disconnected state
        document.getElementById('terminalContainer').classList.remove('hidden');
        document.getElementById('disconnectedState').classList.add('hidden');
        document.getElementById('connectionStatus').classList.remove('hidden');
        document.getElementById('connectionForm').classList.add('hidden');
        
        // Auto-focus input field when output is received
        if (!isConnected) {
            setTimeout(() => {
                const terminalInput = document.getElementById('terminalInput');
                if (terminalInput) {
                    terminalInput.focus();
                }
            }, 200);
        }
        
        isConnected = true;
    }
});

socket.on('error', (error) => {
    console.error('Console error:', error);
    const btn = document.getElementById('connectBtn');
    if (btn) {
        btn.innerHTML = '<i class="fas fa-terminal"></i><span>Connect to Console</span>';
        btn.disabled = false;
    }
    
    // Show error but don't use alert for every error
    const terminal = document.getElementById('terminal');
    if (terminal && !isConnected) {
        terminal.innerHTML += '\r\n\x1b[31mError: ' + error + '\x1b[0m\r\n';
    } else if (!isConnected) {
        alert('Connection error: ' + error);
    }
});

socket.on('shell_exit', () => {
    isConnected = false;
    document.getElementById('terminalContainer').classList.add('hidden');
    document.getElementById('disconnectedState').classList.remove('hidden');
    document.getElementById('connectionStatus').classList.add('hidden');
    document.getElementById('connectionForm').classList.remove('hidden');
    document.getElementById('connectBtn').innerHTML = '<i class="fas fa-plug"></i><span>Connect to SSH</span>';
    document.getElementById('connectBtn').disabled = false;
});

// Handle terminal input - use hidden input field for better keyboard capture
const terminalInput = document.getElementById('terminalInput');
const terminal = document.getElementById('terminal');
const terminalContainer = document.getElementById('terminalContainer');

// Focus the hidden input when clicking on terminal
terminalContainer.addEventListener('click', () => {
    if (isConnected && !terminalContainer.classList.contains('hidden')) {
        terminalInput.focus();
    }
});

terminal.addEventListener('click', () => {
    if (isConnected && !terminalContainer.classList.contains('hidden')) {
        terminalInput.focus();
    }
});

// Handle keyboard input through the hidden input field
terminalInput.addEventListener('keydown', (e) => {
    if (!isConnected || terminalContainer.classList.contains('hidden')) {
        return;
    }
    
    // Prevent default to avoid input field showing text
    e.preventDefault();
    e.stopPropagation();
    
    let keyToSend = null;
    
    // Handle special keys
    if (e.key === 'Enter') {
        keyToSend = '\r\n';
    } else if (e.key === 'Backspace') {
        keyToSend = '\b';
    } else if (e.key === 'Delete') {
        keyToSend = '\x7f';
    } else if (e.key === 'Tab') {
        keyToSend = '\t';
        e.preventDefault(); // Prevent tab from moving focus
    } else if (e.key === 'Escape') {
        keyToSend = '\x1b';
    } else if (e.key === 'ArrowUp') {
        keyToSend = '\x1b[A';
    } else if (e.key === 'ArrowDown') {
        keyToSend = '\x1b[B';
    } else if (e.key === 'ArrowRight') {
        keyToSend = '\x1b[C';
    } else if (e.key === 'ArrowLeft') {
        keyToSend = '\x1b[D';
    } else if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
        // Regular character (but not Ctrl/Cmd combinations)
        keyToSend = e.key;
    }
    
    // Send the key if we have something to send
    if (keyToSend !== null && isConnected) {
        socket.emit('input', keyToSend);
    }
    
    // Clear the input field
    terminalInput.value = '';
});

// Also handle global keydown for when input might not be focused
document.addEventListener('keydown', (e) => {
    // Only handle if terminal is visible and we're not in an input field
    if (!isConnected || terminalContainer.classList.contains('hidden')) {
        return;
    }
    
    // If we're typing in the terminal area and input field is not focused, focus it
    if (terminalContainer.contains(e.target) && document.activeElement !== terminalInput) {
        terminalInput.focus();
    }
});

// Handle resize events
socket.on('resize', (data) => {
    socket.emit('resize', data);
});

// Handle window resize
window.addEventListener('resize', () => {
    if (isConnected) {
        const cols = Math.floor(window.innerWidth / 8);
        const rows = Math.floor(window.innerHeight / 17);
        socket.emit('resize', { cols, rows });
    }
});
</script>

<style>
#terminal {
    font-family: 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.2;
    white-space: pre-wrap;
    word-wrap: break-word;
}

#terminal:focus {
    outline: none;
}

.loading-spinner {
    border: 2px solid #f3f4f6;
    border-top: 2px solid #3b82f6;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}